<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliPen Grammar Overlay Test - Fixed</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .test-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .test-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
            resize: vertical;
        }

        .test-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .test-button:hover {
            background: #5a67d8;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
    </style>
</head>

<body>
    <h1>üñãÔ∏è IntelliPen Grammar Overlay Test (Fixed)</h1>

    <div class="status info">
        <strong>Test Status:</strong> <span id="testStatus">Initializing...</span>
    </div>

    <div class="test-container">
        <h3>Test Input Fields</h3>
        <p>Type some text with grammar errors to test the overlay system:</p>

        <input type="text" class="test-input" id="testInput1" placeholder="I seen him yesterday at the store..."
            value="I seen him yesterday">

        <textarea class="test-input" id="testTextarea" rows="4"
            placeholder="Type a longer text with multiple errors...">The thing is that I seen him yesterday and he was very good at his job.</textarea>

        <div contenteditable="true" class="test-input" id="testContentEditable" style="min-height: 60px;">
            Click here and type some text with errors...
        </div>
    </div>

    <div class="test-container">
        <h3>Test Controls</h3>
        <button class="test-button" onclick="showDemoSuggestions()">Show Demo Suggestions</button>
        <button class="test-button" onclick="testInputField()">Test Input Field</button>
        <button class="test-button" onclick="testTextarea()">Test Textarea</button>
        <button class="test-button" onclick="testContentEditable()">Test ContentEditable</button>
        <button class="test-button" onclick="forceShowOverlay()">Force Show Overlay</button>
        <button class="test-button" onclick="hideOverlay()">Hide Overlay</button>
        <button class="test-button" onclick="debugOverlay()">Debug Overlay</button>
    </div>

    <div class="test-container">
        <h3>Console Output</h3>
        <div id="consoleOutput"
            style="background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
        </div>
    </div>

    <script src="content-scripts/grammar-overlay.js"></script>
    <script>
        // Override console.log to show output in the page
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const consoleOutput = document.getElementById('consoleOutput');

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.style.color = type === 'error' ? '#f87171' : type === 'warn' ? '#fbbf24' : '#e2e8f0';
            div.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function (...args) {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function (...args) {
            originalConsoleError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        console.warn = function (...args) {
            originalConsoleWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        // Test functions
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('testStatus');
            const statusContainer = statusElement.parentElement;

            statusElement.textContent = message;
            statusContainer.className = `status ${type}`;
        }

        function showDemoSuggestions() {
            if (window.IntelliPenGrammarOverlay) {
                const suggestions = window.IntelliPenGrammarOverlay.createDemoSuggestions();
                const input = document.getElementById('testInput1');
                window.IntelliPenGrammarOverlay.showSuggestionsForElement(input, suggestions);
                updateStatus('Demo suggestions shown', 'success');
            } else {
                updateStatus('Grammar overlay not available', 'error');
            }
        }

        function testInputField() {
            const input = document.getElementById('testInput1');
            const suggestions = [
                {
                    type: 'grammar',
                    original: 'I seen',
                    replacement: 'I saw',
                    explanation: 'Use past tense "saw" instead of "seen"'
                }
            ];

            if (window.IntelliPenGrammarOverlay) {
                window.IntelliPenGrammarOverlay.showSuggestionsForElement(input, suggestions);
                updateStatus('Input field test completed', 'success');
            } else {
                updateStatus('Grammar overlay not available', 'error');
            }
        }

        function testTextarea() {
            const textarea = document.getElementById('testTextarea');
            const suggestions = [
                {
                    type: 'clarity',
                    original: 'The thing is that',
                    replacement: 'The issue is that',
                    explanation: 'More specific and clear language'
                },
                {
                    type: 'style',
                    original: 'very good',
                    replacement: 'excellent',
                    explanation: 'More precise and impactful word choice'
                }
            ];

            if (window.IntelliPenGrammarOverlay) {
                window.IntelliPenGrammarOverlay.showSuggestionsForElement(textarea, suggestions);
                updateStatus('Textarea test completed', 'success');
            } else {
                updateStatus('Grammar overlay not available', 'error');
            }
        }

        function testContentEditable() {
            const contentEditable = document.getElementById('testContentEditable');
            const suggestions = [
                {
                    type: 'grammar',
                    original: 'errors',
                    replacement: 'mistakes',
                    explanation: 'Alternative word choice for variety'
                }
            ];

            if (window.IntelliPenGrammarOverlay) {
                window.IntelliPenGrammarOverlay.showSuggestionsForElement(contentEditable, suggestions);
                updateStatus('ContentEditable test completed', 'success');
            } else {
                updateStatus('Grammar overlay not available', 'error');
            }
        }

        function hideOverlay() {
            if (window.IntelliPenGrammarOverlay) {
                window.IntelliPenGrammarOverlay.hidePopup();
                updateStatus('Overlay hidden', 'success');
            } else {
                updateStatus('Grammar overlay not available', 'error');
            }
        }

        function forceShowOverlay() {
            console.log('Force showing overlay...');

            if (!window.IntelliPenGrammarOverlay) {
                updateStatus('Grammar overlay not available', 'error');
                return;
            }

            // Create a test popup at a fixed position
            const suggestions = [
                {
                    type: 'grammar',
                    original: 'Test error',
                    replacement: 'Test correction',
                    explanation: 'This is a test suggestion'
                }
            ];

            const position = { x: 200, y: 200 };
            const testElement = document.getElementById('testInput1');

            console.log('Calling showSuggestions directly...');
            window.IntelliPenGrammarOverlay.showSuggestions({
                element: testElement,
                suggestions: suggestions,
                position: position
            });

            updateStatus('Force overlay attempted', 'info');
        }

        function debugOverlay() {
            console.log('=== OVERLAY DEBUG INFO ===');
            console.log('window.IntelliPenGrammarOverlay:', window.IntelliPenGrammarOverlay);

            if (window.IntelliPenGrammarOverlay) {
                console.log('Overlay container:', window.IntelliPenGrammarOverlay.overlayContainer);
                console.log('Active popup:', window.IntelliPenGrammarOverlay.activePopup);
                console.log('Is enabled:', window.IntelliPenGrammarOverlay.isEnabled);

                // Check if overlay container exists in DOM
                const container = document.getElementById('intellipen-grammar-overlay');
                console.log('Container in DOM:', container);

                // Check if styles are loaded
                const styles = document.getElementById('intellipen-overlay-styles');
                console.log('Styles loaded:', styles);
            }

            updateStatus('Debug info logged to console', 'info');
        }

        // Initialize test
        function checkOverlayStatus() {
            if (window.IntelliPenGrammarOverlay) {
                updateStatus('Grammar overlay initialized successfully!', 'success');
                console.log('Grammar overlay available:', window.IntelliPenGrammarOverlay);
                return true;
            } else {
                console.log('Grammar overlay not yet available, checking again...');
                return false;
            }
        }

        // Check multiple times with increasing delays
        setTimeout(() => checkOverlayStatus(), 100);
        setTimeout(() => checkOverlayStatus(), 500);
        setTimeout(() => {
            if (!checkOverlayStatus()) {
                updateStatus('Grammar overlay failed to initialize', 'error');
            }
        }, 2000);

        // Add event listeners to test inputs
        document.getElementById('testInput1').addEventListener('focus', function () {
            console.log('Input focused');
        });

        document.getElementById('testTextarea').addEventListener('focus', function () {
            console.log('Textarea focused');
        });

        document.getElementById('testContentEditable').addEventListener('focus', function () {
            console.log('ContentEditable focused');
        });
    </script>
</body>

</html>