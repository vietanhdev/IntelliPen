<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliPen - Fix All Permissions</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        .icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .result {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ†Ô∏è IntelliPen - Fix All Permissions</h1>
        <p>Comprehensive fix for Chrome AI APIs and microphone permissions</p>
    </div>

    <div class="section">
        <h2>üéØ Quick Fix Actions</h2>
        <div class="button-group">
            <button onclick="checkAllPermissions()">üîç Check All Permissions</button>
            <button onclick="requestMicrophonePermission()">üé§ Request Microphone</button>
            <button onclick="testChromeAIAPIs()">ü§ñ Test AI APIs</button>
            <button onclick="runFullDiagnostic()">üîß Full Diagnostic</button>
        </div>
        <div id="quick-results"></div>
    </div>

    <div class="section">
        <h2>üé§ Microphone Permission Fix</h2>
        <div class="instructions">
            <strong>Issue:</strong> "Permission dismissed" error when trying to record audio.<br>
            <strong>Solution:</strong> Grant microphone permission to this page and reload the extension.
        </div>
        <button onclick="requestMicrophonePermission()">üé§ Grant Microphone Permission</button>
        <button onclick="testMicrophone()">üß™ Test Microphone</button>
        <div id="microphone-status"></div>
    </div>

    <div class="section">
        <h2>ü§ñ Chrome AI APIs Status</h2>
        <div class="instructions">
            <strong>Issue:</strong> AI APIs show as unavailable despite model being loaded.<br>
            <strong>Common causes:</strong> Missing permissions, wrong API namespace, or need to enable flags.
        </div>
        <div class="button-group">
            <button onclick="checkChromeFlags()">üö© Check Chrome Flags</button>
            <button onclick="testAINamespaces()">üîç Test API Namespaces</button>
            <button onclick="forceAPIActivation()">‚ö° Force API Activation</button>
        </div>
        <div id="ai-status"></div>
    </div>

    <div class="section">
        <h2>üìã Step-by-Step Instructions</h2>
        <div class="grid">
            <div class="card">
                <h3>1. Chrome Flags</h3>
                <p>Enable these flags in Chrome:</p>
                <ul>
                    <li><code>chrome://flags/#prompt-api-for-gemini-nano</code></li>
                    <li><code>chrome://flags/#summarizer-api</code></li>
                    <li><code>chrome://flags/#writer-api-for-gemini-nano</code></li>
                </ul>
                <button onclick="openChromeFlags()">üö© Open Chrome Flags</button>
            </div>
            
            <div class="card">
                <h3>2. Extension Reload</h3>
                <p>After enabling flags:</p>
                <ol>
                    <li>Go to <code>chrome://extensions/</code></li>
                    <li>Find IntelliPen extension</li>
                    <li>Click reload button</li>
                </ol>
                <button onclick="openExtensions()">üîÑ Open Extensions</button>
            </div>
            
            <div class="card">
                <h3>3. Site Permissions</h3>
                <p>Grant permissions to this page:</p>
                <ol>
                    <li>Click üîí in address bar</li>
                    <li>Allow microphone access</li>
                    <li>Refresh this page</li>
                </ol>
                <button onclick="location.reload()">üîÑ Refresh Page</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üìä Diagnostic Results</h2>
        <div id="diagnostic-log"></div>
    </div>

    <script>
        let logElement;
        
        function log(message, type = 'info') {
            if (!logElement) {
                logElement = document.getElementById('diagnostic-log');
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const icon = icons[type] || '‚ÑπÔ∏è';
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<span class="icon">${icon}</span>[${timestamp}] ${message}`;
            logElement.appendChild(statusDiv);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<span class="icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>${message}`;
            element.appendChild(statusDiv);
        }

        async function checkAllPermissions() {
            const resultElement = document.getElementById('quick-results');
            resultElement.innerHTML = '';
            
            log('Starting comprehensive permission check...');
            
            // Check microphone
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                showStatus('quick-results', 'Microphone: Permission granted ‚úÖ', 'success');
                log('Microphone permission: Granted', 'success');
            } catch (error) {
                showStatus('quick-results', `Microphone: ${error.name} - ${error.message}`, 'error');
                log(`Microphone permission: ${error.message}`, 'error');
            }
            
            // Check AI APIs with multiple namespace attempts
            const aiNamespaces = [
                { name: 'window.ai', path: 'ai' },
                { name: 'self.ai', path: 'ai' },
                { name: 'globalThis.ai', path: 'ai' }
            ];
            
            let aiFound = false;
            for (const ns of aiNamespaces) {
                const aiObj = getNestedProperty(window, ns.path) || getNestedProperty(self, ns.path) || getNestedProperty(globalThis, ns.path);
                if (aiObj) {
                    aiFound = true;
                    showStatus('quick-results', `AI APIs: Found at ${ns.name} ‚úÖ`, 'success');
                    log(`AI APIs found at ${ns.name}`, 'success');
                    
                    // Test individual APIs
                    const apis = ['languageModel', 'summarizer', 'writer', 'rewriter', 'proofreader'];
                    for (const api of apis) {
                        if (aiObj[api]) {
                            try {
                                if (typeof aiObj[api].availability === 'function') {
                                    const availability = await aiObj[api].availability();
                                    showStatus('quick-results', `${api}: ${availability}`, 
                                        availability === 'available' ? 'success' : 'warning');
                                } else {
                                    showStatus('quick-results', `${api}: Available (no availability check)`, 'success');
                                }
                            } catch (error) {
                                showStatus('quick-results', `${api}: Error - ${error.message}`, 'error');
                            }
                        } else {
                            showStatus('quick-results', `${api}: Not found`, 'error');
                        }
                    }
                    break;
                }
            }
            
            if (!aiFound) {
                showStatus('quick-results', 'AI APIs: Not found in any namespace ‚ùå', 'error');
                log('AI APIs not found in any namespace', 'error');
            }
        }

        async function requestMicrophonePermission() {
            const statusElement = document.getElementById('microphone-status');
            statusElement.innerHTML = '';
            
            try {
                showStatus('microphone-status', 'Requesting microphone permission...', 'info');
                log('Requesting microphone permission...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                showStatus('microphone-status', 'Microphone permission granted! ‚úÖ', 'success');
                log('Microphone permission granted successfully', 'success');
                
                // Test recording briefly
                const mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                    showStatus('microphone-status', 'Microphone test recording successful ‚úÖ', 'success');
                    log('Microphone test recording completed', 'success');
                }, 1000);
                
            } catch (error) {
                showStatus('microphone-status', `Permission denied: ${error.message}`, 'error');
                log(`Microphone permission error: ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    showStatus('microphone-status', 'Click the üîí icon in the address bar and allow microphone access', 'warning');
                }
            }
        }

        async function testMicrophone() {
            const statusElement = document.getElementById('microphone-status');
            
            try {
                showStatus('microphone-status', 'Testing microphone...', 'info');
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                showStatus('microphone-status', `Found ${audioInputs.length} audio input device(s)`, 'info');
                
                if (audioInputs.length > 0) {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioContext = new AudioContext();
                    const analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    
                    showStatus('microphone-status', 'Microphone is working and receiving audio ‚úÖ', 'success');
                    
                    // Cleanup
                    setTimeout(() => {
                        stream.getTracks().forEach(track => track.stop());
                        audioContext.close();
                    }, 2000);
                } else {
                    showStatus('microphone-status', 'No audio input devices found', 'error');
                }
                
            } catch (error) {
                showStatus('microphone-status', `Microphone test failed: ${error.message}`, 'error');
            }
        }

        async function testChromeAIAPIs() {
            const statusElement = document.getElementById('ai-status');
            statusElement.innerHTML = '';
            
            log('Testing Chrome AI APIs...');
            
            // Try different ways to access AI APIs
            const accessMethods = [
                () => window.ai,
                () => self.ai,
                () => globalThis.ai,
                () => chrome?.ai,
                () => window.chrome?.ai
            ];
            
            let aiObj = null;
            for (const method of accessMethods) {
                try {
                    const result = method();
                    if (result) {
                        aiObj = result;
                        showStatus('ai-status', `AI APIs found via ${method.toString()}`, 'success');
                        break;
                    }
                } catch (error) {
                    // Continue to next method
                }
            }
            
            if (!aiObj) {
                showStatus('ai-status', 'AI APIs not accessible - checking alternatives...', 'warning');
                
                // Check for individual API constructors
                const constructors = ['LanguageModel', 'Summarizer', 'Writer', 'Rewriter'];
                for (const constructor of constructors) {
                    if (window[constructor]) {
                        showStatus('ai-status', `Found ${constructor} constructor`, 'success');
                    }
                }
                
                return;
            }
            
            // Test each API
            const apis = [
                { name: 'Prompt API', key: 'languageModel' },
                { name: 'Summarizer API', key: 'summarizer' },
                { name: 'Writer API', key: 'writer' },
                { name: 'Rewriter API', key: 'rewriter' },
                { name: 'Proofreader API', key: 'proofreader' }
            ];
            
            for (const api of apis) {
                if (aiObj[api.key]) {
                    try {
                        if (typeof aiObj[api.key].availability === 'function') {
                            const availability = await aiObj[api.key].availability();
                            showStatus('ai-status', `${api.name}: ${availability}`, 
                                availability === 'available' ? 'success' : 
                                availability === 'downloadable' ? 'warning' : 'error');
                            log(`${api.name}: ${availability}`, availability === 'available' ? 'success' : 'warning');
                        } else {
                            showStatus('ai-status', `${api.name}: Available (no availability method)`, 'success');
                        }
                    } catch (error) {
                        showStatus('ai-status', `${api.name}: Error - ${error.message}`, 'error');
                        log(`${api.name}: ${error.message}`, 'error');
                    }
                } else {
                    showStatus('ai-status', `${api.name}: Not found`, 'error');
                }
            }
        }

        async function checkChromeFlags() {
            showStatus('ai-status', 'Chrome flags need to be checked manually', 'info');
            showStatus('ai-status', 'Opening chrome://flags/ - look for AI-related flags', 'info');
            log('User needs to check Chrome flags manually');
        }

        async function testAINamespaces() {
            const statusElement = document.getElementById('ai-status');
            
            log('Testing different AI API namespaces...');
            
            const namespaces = [
                'window.ai',
                'self.ai', 
                'globalThis.ai',
                'chrome.ai',
                'window.chrome.ai',
                'LanguageModel',
                'Summarizer',
                'Writer',
                'Rewriter'
            ];
            
            for (const ns of namespaces) {
                try {
                    const obj = getNestedProperty(window, ns) || window[ns];
                    if (obj) {
                        showStatus('ai-status', `‚úÖ Found: ${ns}`, 'success');
                        log(`Found namespace: ${ns}`, 'success');
                    } else {
                        showStatus('ai-status', `‚ùå Not found: ${ns}`, 'error');
                    }
                } catch (error) {
                    showStatus('ai-status', `‚ùå Error accessing ${ns}: ${error.message}`, 'error');
                }
            }
        }

        async function forceAPIActivation() {
            log('Attempting to force AI API activation...');
            
            // Try to trigger API availability checks
            const attempts = [
                async () => {
                    if (window.ai?.languageModel) {
                        return await window.ai.languageModel.availability();
                    }
                },
                async () => {
                    if (window.LanguageModel) {
                        return await window.LanguageModel.availability();
                    }
                },
                async () => {
                    // Try to create a session to trigger download
                    if (window.ai?.languageModel) {
                        const session = await window.ai.languageModel.create();
                        session.destroy();
                        return 'activated';
                    }
                }
            ];
            
            for (const attempt of attempts) {
                try {
                    const result = await attempt();
                    if (result) {
                        showStatus('ai-status', `API activation result: ${result}`, 'success');
                        log(`API activation successful: ${result}`, 'success');
                        return;
                    }
                } catch (error) {
                    log(`Activation attempt failed: ${error.message}`, 'warning');
                }
            }
            
            showStatus('ai-status', 'Could not force API activation - may need Chrome flags', 'warning');
        }

        async function runFullDiagnostic() {
            log('Running full diagnostic...');
            await checkAllPermissions();
            await testChromeAIAPIs();
            await testAINamespaces();
            log('Full diagnostic completed');
        }

        function openChromeFlags() {
            const flags = [
                'chrome://flags/#prompt-api-for-gemini-nano',
                'chrome://flags/#summarizer-api',
                'chrome://flags/#writer-api-for-gemini-nano',
                'chrome://flags/#rewriter-api-for-gemini-nano'
            ];
            
            flags.forEach(flag => {
                window.open(flag, '_blank');
            });
        }

        function openExtensions() {
            window.open('chrome://extensions/', '_blank');
        }

        function getNestedProperty(obj, path) {
            return path.split('.').reduce((current, key) => {
                return current && current[key] !== undefined ? current[key] : null;
            }, obj);
        }

        // Auto-run on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('IntelliPen Permission Fix Tool loaded');
            setTimeout(() => {
                checkAllPermissions();
            }, 1000);
        });
    </script>
</body>
</html>
</content>