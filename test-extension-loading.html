<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliPen Extension Loading Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .status-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 500;
        }
        
        .status-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }
        
        .test-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .test-area {
            min-height: 100px;
            resize: vertical;
        }
        
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .button:hover {
            background: #2563eb;
        }
        
        .log-area {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üñãÔ∏è IntelliPen Extension Loading Test</h1>
    
    <div class="status-section">
        <h2>Extension Status</h2>
        <div class="status-item">
            <span class="status-label">Extension Loaded:</span>
            <span id="extension-status" class="status-value status-loading">Checking...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Content Script Injected:</span>
            <span id="content-script-status" class="status-value status-loading">Checking...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Grammar Overlay:</span>
            <span id="overlay-status" class="status-value status-loading">Checking...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Platform Adapters:</span>
            <span id="adapter-status" class="status-value status-loading">Checking...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Context Menu:</span>
            <span id="context-menu-status" class="status-value status-loading">Checking...</span>
        </div>
    </div>

    <div class="status-section">
        <h2>Test Text Fields</h2>
        <p>These fields should show the üñãÔ∏è indicator when focused:</p>
        
        <input type="text" class="test-field" placeholder="Test input field - type here and look for IntelliPen indicator">
        
        <textarea class="test-field test-area" placeholder="Test textarea - type some text with errors like 'i seen alot of people'"></textarea>
        
        <div contenteditable="true" class="test-field test-area" style="background: white;">
            Click here to edit this contenteditable div. Try typing some text to test IntelliPen detection.
        </div>
    </div>

    <div class="status-section">
        <h2>Test Actions</h2>
        <button class="button" onclick="testExtensionCommunication()">Test Extension Communication</button>
        <button class="button" onclick="testOverlayManually()">Test Overlay Manually</button>
        <button class="button" onclick="testContextMenu()">Test Context Menu (Select text first)</button>
        <button class="button" onclick="clearLog()">Clear Log</button>
    </div>

    <div class="status-section">
        <h2>Test Log</h2>
        <div id="log-area" class="log-area">
            <div>IntelliPen Extension Loading Test - Ready</div>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('log-area');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#f9fafb';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status-value status-${status}`;
        }

        async function checkExtensionStatus() {
            log('Checking extension status...');
            
            // Check if Chrome extension API is available
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                updateStatus('extension-status', 'error', 'Not Available');
                log('Chrome extension API not available', 'error');
                return false;
            }

            try {
                // Try to communicate with background script
                const response = await chrome.runtime.sendMessage({ type: 'GET_EXTENSION_STATUS' });
                
                if (response && response.success) {
                    updateStatus('extension-status', 'success', 'Loaded');
                    log('Extension communication successful', 'success');
                    log(`Extension initialized: ${response.data.initialized}`, 'info');
                    log(`Active sessions: ${response.data.activeSessions}`, 'info');
                    return true;
                } else {
                    updateStatus('extension-status', 'error', 'No Response');
                    log('Extension not responding', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('extension-status', 'error', 'Error');
                log(`Extension error: ${error.message}`, 'error');
                return false;
            }
        }

        function checkContentScript() {
            log('Checking content script injection...');
            
            // Check if content script globals are available
            if (window.intelliPenInjected) {
                updateStatus('content-script-status', 'success', 'Injected');
                log('Content script detected', 'success');
                return true;
            } else {
                updateStatus('content-script-status', 'error', 'Not Found');
                log('Content script not detected', 'error');
                return false;
            }
        }

        function checkOverlay() {
            log('Checking grammar overlay...');
            
            if (window.IntelliPenGrammarOverlay) {
                updateStatus('overlay-status', 'success', 'Available');
                log('Grammar overlay detected', 'success');
                return true;
            } else {
                updateStatus('overlay-status', 'error', 'Not Loaded');
                log('Grammar overlay not found', 'error');
                return false;
            }
        }

        function checkAdapters() {
            log('Checking platform adapters...');
            
            const adapters = ['UniversalAdapter', 'AdapterLoader'];
            const available = adapters.filter(adapter => window[adapter]);
            
            if (available.length > 0) {
                updateStatus('adapter-status', 'success', `${available.length}/${adapters.length} Loaded`);
                log(`Adapters available: ${available.join(', ')}`, 'success');
                return true;
            } else {
                updateStatus('adapter-status', 'error', 'None Loaded');
                log('No adapters found', 'error');
                return false;
            }
        }

        function checkContextMenu() {
            log('Checking context menu...');
            
            // We can't directly check if context menus are registered,
            // but we can check if the extension is loaded
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                updateStatus('context-menu-status', 'success', 'Available');
                log('Context menu should be available (extension loaded)', 'success');
                return true;
            } else {
                updateStatus('context-menu-status', 'error', 'Not Available');
                log('Context menu not available (extension not loaded)', 'error');
                return false;
            }
        }

        async function testExtensionCommunication() {
            log('Testing extension communication...');
            
            try {
                const response = await chrome.runtime.sendMessage({
                    type: 'GET_API_AVAILABILITY'
                });
                
                if (response && response.success) {
                    log('API availability check successful', 'success');
                    log(`Available APIs: ${Object.keys(response.data).length}`, 'info');
                    
                    for (const [api, status] of Object.entries(response.data)) {
                        log(`  ${api}: ${status}`, 'info');
                    }
                } else {
                    log('API availability check failed', 'error');
                }
            } catch (error) {
                log(`Communication test failed: ${error.message}`, 'error');
            }
        }

        async function testOverlayManually() {
            log('Testing overlay manually...');
            
            const activeElement = document.activeElement;
            if (!activeElement || (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA' && activeElement.contentEditable !== 'true')) {
                log('Please click on a text field first', 'error');
                return;
            }

            try {
                await chrome.runtime.sendMessage({
                    type: 'SHOW_WRITING_OVERLAY',
                    data: { action: 'show-overlay' }
                });
                log('Overlay test message sent', 'success');
            } catch (error) {
                log(`Overlay test failed: ${error.message}`, 'error');
            }
        }

        function testContextMenu() {
            log('Testing context menu...');
            
            const selection = window.getSelection().toString();
            if (!selection) {
                log('Please select some text first, then right-click to see IntelliPen menu', 'error');
                return;
            }
            
            log(`Selected text: "${selection.substring(0, 50)}..."`, 'info');
            log('Right-click on the selected text to see IntelliPen context menu', 'success');
        }

        function clearLog() {
            logArea.innerHTML = '<div>Log cleared</div>';
        }

        // Run initial checks
        async function runInitialChecks() {
            log('Starting IntelliPen extension tests...');
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for extension to load
            
            await checkExtensionStatus();
            checkContentScript();
            checkOverlay();
            checkAdapters();
            checkContextMenu();
            
            log('Initial checks completed');
        }

        // Add event listeners for text field focus
        document.addEventListener('focus', (e) => {
            if (e.target.classList.contains('test-field')) {
                log(`Focused on ${e.target.tagName.toLowerCase()}: ${e.target.placeholder || 'contenteditable'}`, 'info');
            }
        }, true);

        // Add event listener for text selection
        document.addEventListener('mouseup', () => {
            const selection = window.getSelection().toString();
            if (selection && selection.length > 5) {
                log(`Text selected: "${selection.substring(0, 30)}..." (${selection.length} chars)`, 'info');
            }
        });

        // Run checks when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runInitialChecks, 500);
        });

        // Re-run checks every 5 seconds
        setInterval(() => {
            checkContentScript();
            checkOverlay();
            checkAdapters();
        }, 5000);
    </script>
</body>
</html>
