<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { background: #007cba; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîç Object Detection Test</h1>
    
    <button class="button" onclick="testObjectDetection()">Test Object Detection</button>
    <button class="button" onclick="clearLog()">Clear Log</button>
    
    <div id="log" class="log"></div>

    <script>
        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testObjectDetection() {
            log('=== TESTING OBJECT DETECTION ===');
            
            // Test 1: Set a simple object
            window.testObject = { test: true };
            log('Set window.testObject = { test: true }');
            log('window.testObject: ' + JSON.stringify(window.testObject));
            log('!!window.testObject: ' + !!window.testObject);
            log('!window.testObject: ' + !window.testObject);
            
            // Test 2: Simulate the exact same pattern as the overlay
            class TestOverlay {
                constructor() {
                    this.isEnabled = true;
                    this.overlayContainer = document.createElement('div');
                }
            }
            
            window.TestOverlay = new TestOverlay();
            log('Created window.TestOverlay');
            log('window.TestOverlay: ' + window.TestOverlay);
            log('typeof window.TestOverlay: ' + typeof window.TestOverlay);
            log('!!window.TestOverlay: ' + !!window.TestOverlay);
            log('!window.TestOverlay: ' + !window.TestOverlay);
            
            // Test 3: Simulate the waiting loop
            log('--- Simulating waiting loop ---');
            let retries = 0;
            const maxRetries = 3;
            
            while (!window.TestOverlay && retries < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
                log(`Waiting... attempt ${retries}`);
                log(`window.TestOverlay: ${window.TestOverlay}`);
                log(`!!window.TestOverlay: ${!!window.TestOverlay}`);
                log(`!window.TestOverlay: ${!window.TestOverlay}`);
            }
            
            if (window.TestOverlay) {
                log('‚úÖ TestOverlay found after waiting');
            } else {
                log('‚ùå TestOverlay not found after waiting');
            }
            
            // Test 4: Load the actual grammar overlay
            log('--- Loading actual grammar overlay ---');
            
            try {
                const script = document.createElement('script');
                script.src = 'content-scripts/grammar-overlay.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = async () => {
                        log('Grammar overlay script loaded');
                        
                        // Force initialization
                        if (typeof window.initializeGrammarOverlay === 'function') {
                            log('Calling initializeGrammarOverlay...');
                            window.initializeGrammarOverlay();
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 50));
                        log('After delay, window.IntelliPenGrammarOverlay: ' + window.IntelliPenGrammarOverlay);
                        
                        resolve();
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                // Test the waiting loop with the real object
                log('--- Testing waiting loop with real overlay ---');
                retries = 0;
                
                while (!window.IntelliPenGrammarOverlay && retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                    log(`Real waiting... attempt ${retries}`);
                    log(`window.IntelliPenGrammarOverlay: ${window.IntelliPenGrammarOverlay}`);
                    log(`typeof: ${typeof window.IntelliPenGrammarOverlay}`);
                    log(`!!window.IntelliPenGrammarOverlay: ${!!window.IntelliPenGrammarOverlay}`);
                    log(`!window.IntelliPenGrammarOverlay: ${!window.IntelliPenGrammarOverlay}`);
                }
                
                if (window.IntelliPenGrammarOverlay) {
                    log('‚úÖ Real overlay found after waiting');
                } else {
                    log('‚ùå Real overlay not found after waiting');
                }
                
            } catch (error) {
                log('‚ùå Error loading grammar overlay: ' + error.message);
            }
        }
        
        log('Page loaded. Click "Test Object Detection" to run tests.');
    </script>
</body>
</html>"