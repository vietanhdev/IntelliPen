<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Menu Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { background: #007cba; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ddd; border-radius: 4px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .text-area { width: 100%; height: 100px; padding: 10px; margin: 10px 0; border: 2px solid #ddd; border-radius: 4px; resize: vertical; }
    </style>
</head>
<body>
    <h1>üñãÔ∏è Context Menu Fix Test</h1>
    
    <p><strong>Instructions:</strong> Select some text below and right-click to use IntelliPen context menu options.</p>
    
    <input type="text" class="input" placeholder="Type here..." value="I seen him yesterday and he was very good">
    
    <textarea class="text-area" placeholder="Type longer text here...">The thing is that I seen him yesterday and he was very good at his job. There is alot of things to consider.</textarea>
    
    <div contenteditable="true" class="input" style="min-height: 60px; border-style: dashed;">
        Click here and type some text with errors to test contentEditable...
    </div>
    
    <button class="button" onclick="simulateContextMenu()">Simulate Context Menu Action</button>
    <button class="button" onclick="checkOverlayStatus()">Check Overlay Status</button>
    <button class="button" onclick="clearLog()">Clear Log</button>
    
    <div id="log" class="log"></div>

    <!-- Load both scripts like the extension does -->
    <script src="content-scripts/universal-integration.js"></script>
    
    <script>
        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function simulateContextMenu() {
            log('Simulating context menu action...');
            
            // Get selected text or use default
            const selectedText = window.getSelection().toString() || 'I seen him yesterday';
            log('Selected text: "' + selectedText + '"');
            
            // Simulate the message that would come from background script
            const message = {
                type: 'SHOW_GRAMMAR_OVERLAY',
                data: {
                    text: selectedText,
                    action: 'grammar-check',
                    position: { x: 200, y: 200 }
                }
            };
            
            // Find the universal integration instance
            if (window.universalTextIntegration) {
                log('Found universal integration, calling handleShowGrammarOverlay...');
                window.universalTextIntegration.handleShowGrammarOverlay(message.data);
            } else {
                log('‚ùå Universal integration not found');
            }
        }
        
        function checkOverlayStatus() {
            log('=== OVERLAY STATUS ===');
            log('window.IntelliPenGrammarOverlay: ' + !!window.IntelliPenGrammarOverlay);
            log('window.universalTextIntegration: ' + !!window.universalTextIntegration);
            
            if (window.IntelliPenGrammarOverlay) {
                const overlay = window.IntelliPenGrammarOverlay;
                log('overlay.overlayContainer: ' + !!overlay.overlayContainer);
                log('overlay.isEnabled: ' + overlay.isEnabled);
                
                const container = document.getElementById('intellipen-grammar-overlay');
                log('Container in DOM: ' + !!container);
                if (container) {
                    log('Container children: ' + container.children.length);
                }
            }
        }
        
        // Wait for initialization
        setTimeout(() => {
            log('Page loaded, checking status...');
            checkOverlayStatus();
        }, 2000);
        
        // Add selection listener
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection().toString();
            if (selection.length > 0) {
                log('Text selected: "' + selection.substring(0, 50) + (selection.length > 50 ? '...' : '') + '"');
            }
        });
    </script>
</body>
</html>