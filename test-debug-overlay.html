<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Overlay Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { background: #007cba; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üñãÔ∏è Debug Overlay Test</h1>
    
    <input type="text" class="input" placeholder="Test input field" value="I seen him yesterday">
    
    <button class="button" onclick="debugOverlayState()">Debug Overlay State</button>
    <button class="button" onclick="forceShowOverlay()">Force Show Overlay</button>
    <button class="button" onclick="createManualOverlay()">Create Manual Overlay</button>
    <button class="button" onclick="clearLog()">Clear Log</button>
    
    <div id="log" class="log"></div>

    <script src="content-scripts/grammar-overlay.js"></script>
    
    <script>
        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function debugOverlayState() {
            log('=== DEBUGGING OVERLAY STATE ===');
            
            // Check if overlay object exists
            log('window.IntelliPenGrammarOverlay: ' + !!window.IntelliPenGrammarOverlay);
            
            if (window.IntelliPenGrammarOverlay) {
                const overlay = window.IntelliPenGrammarOverlay;
                
                log('overlay.overlayContainer: ' + !!overlay.overlayContainer);
                log('overlay.activePopup: ' + !!overlay.activePopup);
                log('overlay.isEnabled: ' + overlay.isEnabled);
                
                // Check DOM container
                const container = document.getElementById('intellipen-grammar-overlay');
                log('DOM container exists: ' + !!container);
                
                if (container) {
                    log('Container display: ' + window.getComputedStyle(container).display);
                    log('Container visibility: ' + window.getComputedStyle(container).visibility);
                    log('Container z-index: ' + window.getComputedStyle(container).zIndex);
                    log('Container children: ' + container.children.length);
                    log('Container innerHTML length: ' + container.innerHTML.length);
                    
                    // Check container position
                    const rect = container.getBoundingClientRect();
                    log('Container position: ' + JSON.stringify({
                        top: rect.top,
                        left: rect.left,
                        width: rect.width,
                        height: rect.height
                    }));
                }
                
                // Check if styles are loaded
                const styles = document.getElementById('intellipen-overlay-styles');
                log('Styles loaded: ' + !!styles);
                
                if (styles) {
                    log('Styles content length: ' + styles.textContent.length);
                }
            }
        }
        
        function forceShowOverlay() {
            log('=== FORCING OVERLAY SHOW ===');
            
            if (!window.IntelliPenGrammarOverlay) {
                log('‚ùå No overlay object found');
                return;
            }
            
            const overlay = window.IntelliPenGrammarOverlay;
            
            // Create test suggestions
            const suggestions = [
                {
                    type: 'grammar',
                    original: 'I seen',
                    replacement: 'I saw',
                    explanation: 'Use past tense "saw" instead of "seen"'
                }
            ];
            
            const position = { x: 100, y: 100 };
            const element = document.querySelector('input');
            
            log('Calling showSuggestions with:');
            log('- suggestions: ' + JSON.stringify(suggestions));
            log('- position: ' + JSON.stringify(position));
            log('- element: ' + element.tagName);
            
            try {
                overlay.showSuggestions({
                    element: element,
                    suggestions: suggestions,
                    position: position
                });
                
                log('‚úÖ showSuggestions called successfully');
                
                // Check if popup was created
                setTimeout(() => {
                    const container = document.getElementById('intellipen-grammar-overlay');
                    if (container) {
                        log('Container children after call: ' + container.children.length);
                        if (container.children.length > 0) {
                            log('‚úÖ Popup was created!');
                            for (let i = 0; i < container.children.length; i++) {
                                const child = container.children[i];
                                log('Child ' + i + ': ' + child.tagName + ' class=' + child.className);
                            }
                        } else {
                            log('‚ùå No popup children found');
                        }
                    }
                }, 100);
                
            } catch (error) {
                log('‚ùå Error calling showSuggestions: ' + error.message);
                log('Error stack: ' + error.stack);
            }
        }
        
        function createManualOverlay() {
            log('=== CREATING MANUAL OVERLAY ===');
            
            // Find or create container
            let container = document.getElementById('intellipen-grammar-overlay');
            if (!container) {
                log('Creating new container...');
                container = document.createElement('div');
                container.id = 'intellipen-grammar-overlay';
                container.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    pointer-events: none !important;
                    z-index: 999999 !important;
                `;
                document.body.appendChild(container);
                log('‚úÖ Container created and added to body');
            }
            
            // Create popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: absolute !important;
                top: 50px !important;
                left: 50px !important;
                background: white !important;
                border: 2px solid #007cba !important;
                padding: 20px !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                pointer-events: auto !important;
                z-index: 1000000 !important;
                min-width: 250px !important;
            `;
            
            popup.innerHTML = `
                <div style="background: #007cba; color: white; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 6px 6px 0 0;">
                    <strong>üñãÔ∏è Manual Test Popup</strong>
                    <button onclick="this.closest('[style*=position]').remove()" style="float: right; background: none; border: none; color: white; cursor: pointer;">√ó</button>
                </div>
                <div>
                    <p><strong>Original:</strong> I seen him</p>
                    <p><strong>Suggestion:</strong> I saw him</p>
                    <p><em>Use past tense "saw" instead of "seen"</em></p>
                    <button onclick="this.closest('[style*=position]').remove()" style="background: #007cba; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Apply</button>
                </div>
            `;
            
            container.appendChild(popup);
            log('‚úÖ Manual popup created and added to container');
            log('Container now has ' + container.children.length + ' children');
        }
        
        // Initialize
        setTimeout(() => {
            log('Page loaded, checking overlay...');
            debugOverlayState();
        }, 1000);
    </script>
</body>
</html>