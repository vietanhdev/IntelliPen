<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome AI APIs Diagnostic Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        .status-available { border-left: 4px solid #28a745; }
        .status-unavailable { border-left: 4px solid #dc3545; }
        .status-downloadable { border-left: 4px solid #ffc107; }
        .status-unknown { border-left: 4px solid #6c757d; }
        
        .requirement {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .requirement.met { border-left: 4px solid #28a745; }
        .requirement.not-met { border-left: 4px solid #dc3545; }
        .requirement.unknown { border-left: 4px solid #ffc107; }
        
        .icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .code {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        
        .log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Chrome AI APIs Diagnostic Tool</h1>
        <p>Comprehensive diagnostic and setup tool for Chrome's built-in AI APIs</p>
    </div>

    <div class="section">
        <h2>üìã System Requirements Check</h2>
        <div id="requirements-check">
            <div class="requirement unknown">
                <span class="icon">üåê</span>
                <div>
                    <strong>Chrome Version:</strong> <span id="chrome-version">Checking...</span>
                    <div><small>Required: Chrome 138+ for most APIs</small></div>
                </div>
            </div>
            <div class="requirement unknown">
                <span class="icon">üíæ</span>
                <div>
                    <strong>Storage:</strong> <span id="storage-info">Checking...</span>
                    <div><small>Required: 22GB+ free space for Gemini Nano</small></div>
                </div>
            </div>
            <div class="requirement unknown">
                <span class="icon">üñ•Ô∏è</span>
                <div>
                    <strong>Platform:</strong> <span id="platform-info">Checking...</span>
                    <div><small>Required: Windows 10+, macOS 13+, Linux, or ChromeOS</small></div>
                </div>
            </div>
            <div class="requirement unknown">
                <span class="icon">üåê</span>
                <div>
                    <strong>Network:</strong> <span id="network-info">Checking...</span>
                    <div><small>Required: Unmetered connection for model download</small></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üîß Chrome AI APIs Status</h2>
        <button onclick="checkAllAPIs()">üîÑ Check API Availability</button>
        <button onclick="downloadModels()">‚¨áÔ∏è Download Models</button>
        <button onclick="testAPIs()">üß™ Test APIs</button>
        
        <div class="status-grid" id="api-status">
            <!-- API status cards will be populated here -->
        </div>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è Setup Instructions</h2>
        <div id="setup-instructions">
            <h3>1. Enable Chrome Flags (if needed)</h3>
            <p>Some APIs may require enabling experimental flags:</p>
            <div class="code">
chrome://flags/#prompt-api-for-gemini-nano
chrome://flags/#writer-api-for-gemini-nano  
chrome://flags/#rewriter-api-for-gemini-nano
chrome://flags/#proofreader-api-for-gemini-nano
chrome://flags/#summarizer-api-for-gemini-nano
chrome://flags/#translator-api-for-gemini-nano
            </div>
            
            <h3>2. Origin Trial Registration</h3>
            <p>Some APIs require origin trial tokens. Add to your manifest.json:</p>
            <div class="code">
{
  "trial_tokens": [
    "YOUR_ORIGIN_TRIAL_TOKEN_HERE"
  ]
}
            </div>
            
            <h3>3. Check Model Status</h3>
            <p>Visit <code>chrome://on-device-internals</code> to check model download status.</p>
        </div>
    </div>

    <div class="section">
        <h2>üìä Diagnostic Log</h2>
        <div class="log" id="diagnostic-log"></div>
    </div>

    <script>
        let logElement;
        
        function log(message, type = 'info') {
            if (!logElement) {
                logElement = document.getElementById('diagnostic-log');
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function checkSystemRequirements() {
            log('Checking system requirements...');
            
            // Chrome version
            const userAgent = navigator.userAgent;
            const chromeMatch = userAgent.match(/Chrome\/(\d+)/);
            const chromeVersion = chromeMatch ? parseInt(chromeMatch[1]) : 0;
            
            const chromeVersionEl = document.getElementById('chrome-version');
            const chromeReq = chromeVersionEl.closest('.requirement');
            
            if (chromeVersion >= 138) {
                chromeVersionEl.textContent = `${chromeVersion} ‚úÖ`;
                chromeReq.className = 'requirement met';
                log(`Chrome version ${chromeVersion} meets requirements`, 'success');
            } else {
                chromeVersionEl.textContent = `${chromeVersion} ‚ùå (Need 138+)`;
                chromeReq.className = 'requirement not-met';
                log(`Chrome version ${chromeVersion} is too old. Need 138+`, 'error');
            }
            
            // Platform info
            const platformEl = document.getElementById('platform-info');
            const platformReq = platformEl.closest('.requirement');
            const platform = navigator.platform;
            const supportedPlatforms = ['Win32', 'MacIntel', 'Linux x86_64', 'Linux armv7l'];
            
            if (supportedPlatforms.some(p => platform.includes(p.split(' ')[0]))) {
                platformEl.textContent = `${platform} ‚úÖ`;
                platformReq.className = 'requirement met';
                log(`Platform ${platform} is supported`, 'success');
            } else {
                platformEl.textContent = `${platform} ‚ö†Ô∏è`;
                platformReq.className = 'requirement unknown';
                log(`Platform ${platform} support unknown`, 'warning');
            }
            
            // Storage (estimate)
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const availableGB = Math.round((estimate.quota - estimate.usage) / (1024 * 1024 * 1024));
                    
                    const storageEl = document.getElementById('storage-info');
                    const storageReq = storageEl.closest('.requirement');
                    
                    if (availableGB >= 22) {
                        storageEl.textContent = `~${availableGB}GB available ‚úÖ`;
                        storageReq.className = 'requirement met';
                        log(`Storage: ~${availableGB}GB available (sufficient)`, 'success');
                    } else {
                        storageEl.textContent = `~${availableGB}GB available ‚ùå (Need 22GB+)`;
                        storageReq.className = 'requirement not-met';
                        log(`Storage: ~${availableGB}GB available (insufficient)`, 'error');
                    }
                } catch (error) {
                    document.getElementById('storage-info').textContent = 'Unable to check';
                    log('Could not check storage availability', 'warning');
                }
            } else {
                document.getElementById('storage-info').textContent = 'API not supported';
                log('Storage estimation API not supported', 'warning');
            }
            
            // Network (basic check)
            const networkEl = document.getElementById('network-info');
            const connection = navigator.connection;
            if (connection) {
                const isMetered = connection.saveData || connection.effectiveType === 'slow-2g';
                networkEl.textContent = isMetered ? 'Possibly metered ‚ö†Ô∏è' : 'Likely unmetered ‚úÖ';
                log(`Network: ${connection.effectiveType}, metered: ${isMetered}`, isMetered ? 'warning' : 'success');
            } else {
                networkEl.textContent = 'Unable to detect';
                log('Network connection details unavailable', 'warning');
            }
        }

        async function checkAllAPIs() {
            log('Checking Chrome AI API availability...');
            
            const apis = [
                { name: 'Prompt API', key: 'prompt', namespace: 'ai.languageModel' },
                { name: 'Proofreader API', key: 'proofreader', namespace: 'ai.proofreader' },
                { name: 'Writer API', key: 'writer', namespace: 'ai.writer' },
                { name: 'Rewriter API', key: 'rewriter', namespace: 'ai.rewriter' },
                { name: 'Summarizer API', key: 'summarizer', namespace: 'ai.summarizer' },
                { name: 'Translator API', key: 'translator', namespace: 'ai.translator' }
            ];
            
            const statusContainer = document.getElementById('api-status');
            statusContainer.innerHTML = '';
            
            for (const api of apis) {
                const card = document.createElement('div');
                card.className = 'status-card';
                
                let status = 'unknown';
                let statusText = 'Checking...';
                let details = '';
                
                try {
                    // Check if API exists
                    const apiObj = getNestedProperty(window, api.namespace);
                    
                    if (!apiObj) {
                        status = 'unavailable';
                        statusText = 'Not Available';
                        details = 'API not found in browser';
                        log(`${api.name}: Not found in browser`, 'error');
                    } else {
                        // Check availability if method exists
                        if (typeof apiObj.availability === 'function') {
                            try {
                                const availability = await apiObj.availability();
                                status = availability;
                                statusText = availability.charAt(0).toUpperCase() + availability.slice(1);
                                
                                if (availability === 'available') {
                                    details = 'Ready to use';
                                    log(`${api.name}: Available and ready`, 'success');
                                } else if (availability === 'downloadable') {
                                    details = 'Model needs to be downloaded';
                                    log(`${api.name}: Available but needs download`, 'warning');
                                } else {
                                    details = `Status: ${availability}`;
                                    log(`${api.name}: Status ${availability}`, 'warning');
                                }
                            } catch (error) {
                                status = 'unavailable';
                                statusText = 'Error';
                                details = error.message;
                                log(`${api.name}: Error checking availability - ${error.message}`, 'error');
                            }
                        } else if (typeof apiObj.create === 'function') {
                            status = 'available';
                            statusText = 'Available';
                            details = 'No availability check method';
                            log(`${api.name}: Available (no availability method)`, 'success');
                        } else {
                            status = 'unavailable';
                            statusText = 'Incomplete';
                            details = 'Missing create method';
                            log(`${api.name}: Incomplete API object`, 'error');
                        }
                    }
                } catch (error) {
                    status = 'unavailable';
                    statusText = 'Error';
                    details = error.message;
                    log(`${api.name}: Unexpected error - ${error.message}`, 'error');
                }
                
                card.className = `status-card status-${status}`;
                card.innerHTML = `
                    <h4>${api.name}</h4>
                    <div><strong>Status:</strong> ${statusText}</div>
                    <div><small>${details}</small></div>
                `;
                
                statusContainer.appendChild(card);
            }
        }

        async function downloadModels() {
            log('Attempting to trigger model downloads...');
            
            const apis = ['ai.languageModel', 'ai.proofreader', 'ai.writer', 'ai.rewriter', 'ai.summarizer'];
            
            for (const apiPath of apis) {
                try {
                    const apiObj = getNestedProperty(window, apiPath);
                    if (apiObj && typeof apiObj.create === 'function') {
                        log(`Triggering download for ${apiPath}...`);
                        
                        const session = await apiObj.create({
                            monitor: (m) => {
                                m.addEventListener('downloadprogress', (e) => {
                                    const progress = Math.round(e.loaded * 100);
                                    log(`${apiPath} download: ${progress}%`);
                                });
                            }
                        });
                        
                        log(`${apiPath} session created successfully`, 'success');
                        
                        // Clean up session
                        if (session && typeof session.destroy === 'function') {
                            session.destroy();
                        }
                    }
                } catch (error) {
                    log(`Failed to create ${apiPath} session: ${error.message}`, 'error');
                }
            }
        }

        async function testAPIs() {
            log('Running basic API tests...');
            
            // Test Prompt API
            try {
                const promptAPI = getNestedProperty(window, 'ai.languageModel');
                if (promptAPI) {
                    log('Testing Prompt API...');
                    const session = await promptAPI.create();
                    const result = await session.prompt('Say hello');
                    log(`Prompt API test successful: ${result.substring(0, 50)}...`, 'success');
                    if (session.destroy) session.destroy();
                }
            } catch (error) {
                log(`Prompt API test failed: ${error.message}`, 'error');
            }
            
            // Test Summarizer API
            try {
                const summarizerAPI = getNestedProperty(window, 'ai.summarizer');
                if (summarizerAPI) {
                    log('Testing Summarizer API...');
                    const session = await summarizerAPI.create();
                    const result = await session.summarize('This is a test text that should be summarized into key points.');
                    log(`Summarizer API test successful: ${result}`, 'success');
                    if (session.destroy) session.destroy();
                }
            } catch (error) {
                log(`Summarizer API test failed: ${error.message}`, 'error');
            }
        }

        function getNestedProperty(obj, path) {
            return path.split('.').reduce((current, key) => {
                return current && current[key] !== undefined ? current[key] : null;
            }, obj);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            log('Chrome AI APIs Diagnostic Tool initialized');
            await checkSystemRequirements();
            await checkAllAPIs();
        });
    </script>
</body>
</html>